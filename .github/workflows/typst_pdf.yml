name: Compile All Typst Documents in Docs Folder

on:
  push:
    branches:
      - main
    paths:
      # Trigger when any .typ file in the 'docs' folder changes
      - 'docs/**.typ'
      # Also trigger if the workflow or assets change
      - 'docs/**' 
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**.typ'
      - 'docs/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Typst CLI
      - name: 2. Setup Typst Compiler
        # This action installs the Typst command-line interface (CLI)
        uses: typst-community/setup-typst@v4
      
      # 3. Compile ALL top-level .typ files in the docs/ folder
      - name: 3. Compile All Documents
        run: |
          echo "Starting compilation of all .typ files in docs/..."
          
          # Loop through all files matching the pattern 'docs/*.typ'
          # and run the 'typst compile' command on each one.
          # The resulting PDFs will be placed in the current directory (root of the repo checkout).
          
          # Check if any matching files exist
          shopt -s nullglob
          typst_files=(docs/*.typ)
          
          if [ ${#typst_files[@]} -eq 0 ]; then
            echo "No top-level .typ files found in the 'docs/' directory. Skipping compilation."
            exit 0
          fi
          
          for file in "${typst_files[@]}"; do
            echo "Compiling: $file"
            # -o $(basename "$file" .typ).pdf ensures the output PDF is placed 
            # in the root directory and named correctly (e.g., docs/report.typ -> report.pdf)
            typst compile "$file"
          done
          
      # 4. Upload all generated PDF artifacts
      - name: 4. Upload All Generated PDFs
        uses: actions/upload-artifact@v4
        with:
          # A single, consistent name for the artifact package
          name: compiled-typst-pdfs 
          # Finds and uploads ALL files in the root folder ending in .pdf
          path: '*.pdf'
