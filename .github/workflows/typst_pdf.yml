name: Compile All Typst Documents in Docs Folder

on:
  push:
    branches:
      - main
    paths:
      # mod to comment only, 2nd edit
      # ðŸ”‘ CRITICAL FIX: Include all files in the docs/ folder AND the root directory
      - 'docs/**'
      - '**/*.typ' # Include all .typ files anywhere in the repo
      - '**/*.png' # Include common assets needed by Typst
      - '**/*.jpg'
      - '**.csv'  # Include data files if used
      - '.github/workflows/**' # Always watch the workflow file itself
      - '*' # Watch any file in the root directory (e.g., README.md)

  pull_request:
    branches:
      - main
    paths:
      # Repeat the broad path filter for pull requests
      - 'docs/**'
      - '**/*.typ'
      - '**/*.png'
      - '**/*.jpg'
      - '**.csv'
      - '.github/workflows/**'
      - '*'
      
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ðŸ‘‡ ADD THIS BLOCK HERE
    permissions:
      contents: write # This grants the token permission to push commits
      
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Typst CLI
      - name: 2. Setup Typst Compiler
        # This action installs the Typst command-line interface (CLI)
        uses: typst-community/setup-typst@v4
      
      # 3. Compile All Documents (with Debug Prints)
      - name: 3. Compile All Documents
        run: |
          echo "Starting compilation of all .typ files in docs/..."
          
          shopt -s nullglob
          typst_files=(docs/*.typ)
          
          if [ ${#typst_files[@]} -eq 0 ]; then
            echo "No top-level .typ files found in the 'docs/' directory. Skipping compilation."
            exit 0
          fi
          
          for file in "${typst_files[@]}"; do
            echo "--- Debugging Compilation for: $file ---"
            
            # 1. Get ONLY the filename (e.g., 'my-new-doc.typ')
            base_filename=$(basename "$file")
            
            # 2. Replace .typ with .pdf to get the output name (e.g., 'my-new-doc.pdf')
            output_name="${base_filename/.typ/.pdf}"
            
            # DEBUG: Print the input and output variables
            echo "DEBUG: Input file: '$file'"
            echo "DEBUG: Output name: '$output_name'"
            
            # The command we are trying to execute (Option 1: INPUT -o OUTPUT)
            COMMAND="typst compile \"$file\" -o \"$output_name\""
            echo "DEBUG: Executing command: $COMMAND"
            
            # CRITICAL FIX: Try the alternative syntax where OUTPUT is the final argument
            # This is often the most reliable way to pass arguments to CLI tools.
            # typst compile <INPUT> <OUTPUT>
            typst compile "$file" "$output_name"
            
            echo "Compilation of $file completed successfully."
            
            # If the command above fails, try the explicit -o flag
            # Note: We are only testing one command structure per run to get a clean error.
          done

      # 4. Create an Artifact Directory (Optional, but clean)
      - name: 4. Move PDFs to a Distribution Folder
        # This moves all generated PDFs from the root to a dedicated 'pdf_dist' folder
        run: |
          mkdir pdf_dist
          mv *.pdf pdf_dist/

      # 5. Commit the generated PDF files back to the main branch
      - name: 5. Deploy PDFs to Main Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          # Use the GITHUB_TOKEN which you previously granted 'contents: write' permission
          github_token: ${{ secrets.GITHUB_TOKEN }} 
          
          # ðŸ‘‡ CRITICAL CHANGE 1: Set the target branch to 'main'
          publish_branch: main 
          
          # ðŸ‘‡ CRITICAL CHANGE 2: Define the target directory on the 'main' branch
          # We'll use 'pdf-output' as a simple directory name
          publish_dir: pdf_dist 
          
          # This ensures only the contents of 'pdf_dist' are committed to the target path.
          # We need to tell the action NOT to overwrite the entire branch, 
          # but just to place the files in a subfolder.
          cname: '' # Must be set to an empty string to avoid CNAME issues on main branch
          
          # We commit to a SUBFOLDER of the main branch
          destination_dir: pdf/
          
          # Define a clear commit message
          commit_message: "Automated PDF update: Generated documents from Typst"
          
      # 4. Upload All Generated PDFs (This step is now correct)
      #- name: 4. Upload All Generated PDFs
      #  uses: actions/upload-artifact@v4
      #  with:
      #    name: compiled-typst-pdfs 
      #    # This now correctly finds the PDFs created in the root directory
      #    path: '*.pdf'
