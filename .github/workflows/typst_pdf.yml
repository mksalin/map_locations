name: Compile All Typst Documents in Docs Folder

on:
  push:
    branches:
      - main
    paths:
      # Trigger when any .typ file in the 'docs' folder changes
      - 'docs/**.typ'
      # Also trigger if the workflow or assets change
      - 'docs/**' 
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**.typ'
      - 'docs/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Typst CLI
      - name: 2. Setup Typst Compiler
        # This action installs the Typst command-line interface (CLI)
        uses: typst-community/setup-typst@v4
      
      # 3. Compile All Documents
      - name: 3. Compile All Documents
        run: |
          echo "Starting compilation of all .typ files in docs/..."
          
          # Check if any matching files exist
          shopt -s nullglob
          typst_files=(docs/*.typ)
          
          if [ ${#typst_files[@]} -eq 0 ]; then
            echo "No top-level .typ files found in the 'docs/' directory. Skipping compilation."
            exit 0
          fi
          
          for file in "${typst_files[@]}"; do
            echo "Compiling: $file"
            
            # Use 'basename' to get the filename without the directory or extension, 
            # then append .pdf to define the output file in the root directory.
            output_name=$(basename "$file" .typ).pdf
            
            # ðŸ‘‡ CRITICAL FIX: Ensure the input is first, followed by the -o flag and its value.
            # Using single quotes for the entire command can sometimes help resolve shell ambiguities.
            # typst compile -- "$file" -o "$output_name"
            # Alternative: Place the -o flag before the input file
            typst compile -- -o "$output_name" "$file"
            
            echo "Created $output_name"
          done
          
      # 4. Upload All Generated PDFs (This step is now correct)
      - name: 4. Upload All Generated PDFs
        uses: actions/upload-artifact@v4
        with:
          name: compiled-typst-pdfs 
          # This now correctly finds the PDFs created in the root directory
          path: '*.pdf'
