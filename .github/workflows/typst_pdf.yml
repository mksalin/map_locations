name: Compile All Typst Documents in Docs Folder

on:
  push:
    branches:
      - main
    paths:
      # Trigger when any .typ file in the 'docs' folder changes
      - 'docs/**.typ'
      # Also trigger if the workflow or assets change
      - 'docs/**' 
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**.typ'
      - 'docs/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Typst CLI
      - name: 2. Setup Typst Compiler
        # This action installs the Typst command-line interface (CLI)
        uses: typst-community/setup-typst@v4
      
      # 3. Compile ALL top-level .typ files in the docs/ folder
      - name: 3. Compile All Documents
        run: |
          echo "Starting compilation of all .typ files in docs/..."
          
          shopt -s nullglob
          typst_files=(docs/*.typ)
          
          if [ ${#typst_files[@]} -eq 0 ]; then
            echo "No top-level .typ files found in the 'docs/' directory. Skipping compilation."
            exit 0
          fi
          
          for file in "${typst_files[@]}"; do
            echo "Compiling: $file"
            
            # 1. Get ONLY the filename (e.g., 'my-new-doc.typ')
            base_filename=$(basename "$file")
            
            # 2. Replace .typ with .pdf to get the output name (e.g., 'my-new-doc.pdf')
            output_name="${base_filename/.typ/.pdf}"
            
            # ðŸ‘‡ CRITICAL FIX: Use the most robust command syntax: 
            # typst compile <INPUT> -o <OUTPUT>
            # We use the full path for the input ($file) and the simple filename for the output ($output_name).
            typst compile "$file" -- -o "$output_name"
            
            echo "Created $output_name in the root directory."
          done
          
      # 4. Upload All Generated PDFs (This step is now correct)
      - name: 4. Upload All Generated PDFs
        uses: actions/upload-artifact@v4
        with:
          name: compiled-typst-pdfs 
          # This now correctly finds the PDFs created in the root directory
          path: '*.pdf'
